@{
    ViewData["Title"] = "Statistiques";
    Layout = "~/Views/Shared/_LayoutDashboard.cshtml";

    var totalCandidats = ViewBag.TotalCandidats;
    var tauxReussite = ViewBag.TauxReussite;
    var entretiensThisMonth = ViewBag.EntretiensThisMonth;
    var candidatsEmbauches = ViewBag.CandidatsEmbauches;
    var statutsRepartition = ViewBag.StatutsRepartition as List<dynamic>;
    var topCandidats = ViewBag.TopCandidats as List<WebApplication1.Models.Candidat>;
    var candidaturesParMois = ViewBag.CandidaturesParMois as List<dynamic>;
    var scoresMoyens = ViewBag.ScoresMoyens as List<dynamic>;
}

<div class="page-header mb-4">
    <h1 style="font-size: 2rem; font-weight: 700; color: #111827; margin-bottom: 0.5rem;">?? Statistiques</h1>
    <p style="color: #6b7280; font-size: 1rem;">Vue d'ensemble des performances de recrutement</p>
</div>

<!-- KPIs -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 32px;">
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 24px; color: white; box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);">
        <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 8px;">Total Candidats</div>
        <div style="font-size: 2.5rem; font-weight: 700;">@totalCandidats</div>
    </div>

    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 16px; padding: 24px; color: white; box-shadow: 0 4px 20px rgba(240, 147, 251, 0.4);">
        <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 8px;">Taux de Réussite</div>
        <div style="font-size: 2.5rem; font-weight: 700;">@tauxReussite.ToString("F1")%</div>
    </div>

    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 16px; padding: 24px; color: white; box-shadow: 0 4px 20px rgba(79, 172, 254, 0.4);">
        <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 8px;">Entretiens ce mois</div>
        <div style="font-size: 2.5rem; font-weight: 700;">@entretiensThisMonth</div>
    </div>

    <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); border-radius: 16px; padding: 24px; color: white; box-shadow: 0 4px 20px rgba(67, 233, 123, 0.4);">
        <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 8px;">Candidats Embauchés</div>
        <div style="font-size: 2.5rem; font-weight: 700;">@candidatsEmbauches</div>
    </div>
</div>

<!-- GRAPHIQUES -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 32px;">
    <!-- Évolution des candidatures -->
    <div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <h3 style="font-size: 1.25rem; font-weight: 700; color: #111827; margin-bottom: 20px;">Évolution des candidatures</h3>
        <canvas id="candidaturesChart" style="max-height: 300px;"></canvas>
    </div>

    <!-- Répartition par statut -->
    <div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <h3 style="font-size: 1.25rem; font-weight: 700; color: #111827; margin-bottom: 20px;">Répartition par statut</h3>
        <canvas id="statutsChart" style="max-height: 300px;"></canvas>
    </div>
</div>

<!-- Scores moyens par évaluation -->
<div style="background: white; border-radius: 16px; padding: 24px; margin-bottom: 32px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
    <h3 style="font-size: 1.25rem; font-weight: 700; color: #111827; margin-bottom: 20px;">Scores moyens par évaluation</h3>
    <canvas id="scoresChart" style="max-height: 250px;"></canvas>
</div>

<!-- Top 10 Candidats -->
<div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
    <h3 style="font-size: 1.25rem; font-weight: 700; color: #111827; margin-bottom: 20px;">?? Top 10 Candidats</h3>

    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="border-bottom: 2px solid #e5e7eb;">
                <th style="padding: 12px; text-align: left; font-weight: 600; color: #6b7280; font-size: 0.85rem;">RANG</th>
                <th style="padding: 12px; text-align: left; font-weight: 600; color: #6b7280; font-size: 0.85rem;">CANDIDAT</th>
                <th style="padding: 12px; text-align: center; font-weight: 600; color: #6b7280; font-size: 0.85rem;">SCORE</th>
                <th style="padding: 12px; text-align: center; font-weight: 600; color: #6b7280; font-size: 0.85rem;">STATUT</th>
            </tr>
        </thead>
        <tbody>
            @if (topCandidats != null && topCandidats.Any())
            {
                int rank = 1;
                foreach (var candidat in topCandidats)
                {
                    var medalEmoji = rank == 1 ? "??" : rank == 2 ? "??" : rank == 3 ? "??" : "";

            <tr style="border-bottom: 1px solid #f3f4f6;">
                <td style="padding: 16px; text-align: center; font-size: 1.5rem;">
                    @if (rank <= 3)
                            {
                    @medalEmoji
                            }
                            else
                            {
                    <span style="font-size: 1rem; font-weight: 600; color: #6b7280;">@rank</span>
                            }
                </td>
                <td style="padding: 16px;">
                    <div style="font-weight: 600; color: #111827;">@candidat.Prenom @candidat.Nom</div>
                    <div style="color: #6b7280; font-size: 0.85rem;">@candidat.Email</div>
                </td>
                <td style="padding: 16px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">
                        @candidat.ScoreGlobal?.ToString("F1")%
                    </div>
                </td>
                <td style="padding: 16px; text-align: center;">
                    <span style="padding: 6px 12px; background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid #10b981; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                        @candidat.Statut
                    </span>
                </td>
            </tr>
                    rank++;
                }
            }
            else
            {
            <tr>
                <td colspan="4" style="text-align: center; padding: 40px; color: #6b7280;">
                    Aucune donnée disponible
                </td>
            </tr>
            }
        </tbody>
    </table>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Évolution des candidatures
    const candidaturesCtx = document.getElementById('candidaturesChart').getContext('2d');
    const candidaturesData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(candidaturesParMois ?? new List<dynamic>()));

    const monthNames = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sep', 'Oct', 'Nov', 'Déc'];
    const labels = candidaturesData.map(d => monthNames[d.month - 1] + ' ' + d.year);
    const counts = candidaturesData.map(d => d.count);

    new Chart(candidaturesCtx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Candidatures',
                data: counts,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            }
        }
    });

    // Répartition par statut
    const statutsCtx = document.getElementById('statutsChart').getContext('2d');
    const statutsData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(statutsRepartition ?? new List<dynamic>()));

    const statutLabels = statutsData.map(s => s.statut || 'N/A');
    const statutCounts = statutsData.map(s => s.count);

    new Chart(statutsCtx, {
        type: 'doughnut',
        data: {
            labels: statutLabels,
            datasets: [{
                data: statutCounts,
                backgroundColor: [
                    '#10b981',
                    '#3b82f6',
                    '#f59e0b',
                    '#ef4444',
                    '#8b5cf6',
                    '#ec4899'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Scores moyens
    const scoresCtx = document.getElementById('scoresChart').getContext('2d');
    const scoresData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(scoresMoyens ?? new List<dynamic>()));

    const evalLabels = scoresData.map(s => s.evaluation || 'N/A');
    const evalScores = scoresData.map(s => s.scoreMoyen);

    new Chart(scoresCtx, {
        type: 'bar',
        data: {
            labels: evalLabels,
            datasets: [{
                label: 'Score moyen (%)',
                data: evalScores,
                backgroundColor: '#3b82f6'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
</script>
